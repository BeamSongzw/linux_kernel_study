# Linux内核体系结构

## 内核模式与体系结构

**操作系统的结构**

* 用户应用程序

* 操作系统的服务层 `sys_call` 快递

* 操作系统内核 （文件系统 内存管理 进程管理 驱动管理）

* 硬件系统：驱动



**操作系统的工作方式：**

* 1.把操作系统从用户态 切换到内核态 （用户应用程序 到内核的流程）
* 2.实现操作系统的系统调用 （操作系统服务层）
* 3.应用操作系统提供的底层函数，进行功能实现
  * 3.1 操作系统的驱动结构
* 4.退出后从内核态切换到用户态



**操作系统内核中各级模块的相互关联**

* Linux内核的整体模块：进程调度模块、内存管理模块、文件系统模块、进程间通信模块、驱动管理模块
* 每个模块间的关系
  * 内存管理和驱动管理模块  虚拟内存的缓存和回存机制
  * `VFS` 虚拟文件系统 把硬件当成文件来进行使用

![image-20211105001824353](./image/用户层_内核层.png)

**操作系统结构的独立性**

* 管理层 （管理和实现独立开）
* 实现层

易于升级和维护  1991-2016

高版本的内核

低版本的内核    之间的驱动

多的是内核驱动的种类  内核驱动的管理模式并没有巨大的改变（一段时间3个阶段的条约 零散型 分层型  设备树）

进程的调度算法发生了改变   进程的管理方式并没有巨大的改变



# 内核中断概括

目的：

* 1.硬件的中断响应---->内核驱动中的中断 
* 2.系统调用的函数响应(sys_call)--->系统调用 
* 3.自定义中断--->软件的软中断模式
* 4.信号中断(kill -signalnum)---->对了解信号的使用 创建 等
* 5.系统的异常和错误---->系统的异常获取 了解系统异常的作用

1.Linux的中断机制

* 1.1 分类：硬件中断 软件中断

  * 硬中断：由电脑主机的8259A类似的硬件中断控制芯片发出的中断

    ARM中断控制器发出的中断

  * 软中断：异常 第一类：CPU自行保留的中断

    ​										系统调用异常

* 1.2 代码结构： `asm.s ` `trap.c`

  ​							`system_call.s`       `fork.c`   `signal.c`  `exit.c`  `sys.c`

2.中断的工作流程：

* 2.1  回忆：

  ​	做CPU工作模式的转化

  ​	进行寄存器的拷贝与压栈		

  ​	设置中断异常向量表

  ​	保存正常运行的函数返回值

  ​	跳转到对应的中断服务函数上运行

  ​	进行模式的复原以及寄存器的复原

  ​	跳转回正常工作的函数继续运行

* 2.2 Linux中中断的工作流程：

  ​	1.将所有的寄存器入栈

  ​				（8086中）SS   EFLAGS  ESP  CS  EIP （错误码）  ARM中的（r0-r15)

  ​	2.将异常码入栈（中断号）

  ​	3.将当前的函数返回值进行入栈（为了在中断执行后能够找到在哪里中断的，能够复原）

  -------------------------------------中断前的处理过程------------------------------------------

  ​	4.调用对应的中断服务函数

  -------------------------------------中断前的执行过程------------------------------------------

  ​	5.出栈函数返回值

  ​	6.返回所有入栈的寄存器值

  ------------------------------------中断的恢复过程----------------------------------------------

|                          | 中断前的处理过程，中断的恢复过程 | 中断的执行过程                             |
| ------------------------ | -------------------------------- | ------------------------------------------ |
| 硬件中断的处理过程       | `asm.s`                          | `trap.c`                                   |
| 软件及系统调用的处理过程 | `system_call.s`                  | `fork.c`   `signal.c`   `exit.c`   `sys.c` |



3.中断的代码实现过程

